<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Camagru Gallery</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="styles/main.css" />
</head>
<body class="container py-4">
  <header class="d-flex justify-content-between align-items-center mb-4">
    <h1>Camagru</h1>
    <div id="user-actions" class="d-flex gap-2"></div>
  </header>

  <div id="gallery" class="row g-3"></div>

  <!-- Modal container (required once) -->
  <div id="image-modal" class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-dark bg-opacity-75 d-none" style="z-index: 1050;">
    <div class="modal-content bg-white rounded shadow" style="max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;"></div>
  </div>

  <script type="module">
    import { getCurrentUser, logout } from './js/auth.js';
    import { apiFetch } from './js/api.js';
    import { createImageCard } from './js/components/imageCard.js';
    // import { renderImageCard, openImageModal } from './js/components/imageModal.js';

    const userActions = document.getElementById('user-actions');
    const gallery = document.getElementById('gallery');

    function renderUserButtons() {
      const user = getCurrentUser();
      userActions.innerHTML = '';

      if (user) {
        const profileBtn = document.createElement('a');
        profileBtn.className = 'btn btn-outline-primary';
        profileBtn.href = 'profile.html';
        profileBtn.textContent = 'Profile';

        const logoutBtn = document.createElement('button');
        logoutBtn.className = 'btn btn-outline-danger';
        logoutBtn.textContent = 'Logout';
        logoutBtn.onclick = () => {
          logout();
          location.reload();
        };

        userActions.append(profileBtn, logoutBtn);
      } else {
        const loginBtn = document.createElement('a');
        loginBtn.className = 'btn btn-outline-primary';
        loginBtn.href = 'login.html';
        loginBtn.textContent = 'Login';

        const signupBtn = document.createElement('a');
        signupBtn.className = 'btn btn-outline-success';
        signupBtn.href = 'register.html';
        signupBtn.textContent = 'Sign Up';

        userActions.append(loginBtn, signupBtn);
      }
    }

    async function loadGalleryPage(page = 1) {
      try {
        const res = await apiFetch(`/gallery?page=${page}&per_page=12`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to load gallery');

        const images = data.images || [];

        images.forEach(img => {
          const col = document.createElement('div');
          col.className = 'col-md-4 col-sm-6';
          const card = createImageCard(img, images);
          col.appendChild(card);
          gallery.appendChild(col);
        });

        // Optional: Save pagination state for later infinite scroll
        // e.g., window.galleryPage = page + 1;
      } catch (err) {
        console.error(err);
      }
    }

    renderUserButtons();
    loadGalleryPage(1);
  </script>
</body>
</html>
